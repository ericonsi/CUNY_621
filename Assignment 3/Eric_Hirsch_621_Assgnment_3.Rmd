---
title: "Eric_Hirsch_621_Assignment_3"
author: "Eric Hirsch"
date: "4/7/2022"
output:
  pdf_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning =  FALSE, message = FALSE)
```

```{r}
library(tidyverse)
devtools::install_github("ericonsi/EHData")
library(EHData)
library(patchwork)
library(gridExtra)
library(ggsci)
library(caret)
library(pROC)
library(car)
```
```{r}

df <- read.csv("D:\\RStudio\\CUNY_621\\Assignment 3\\crime-training-data_modified.csv")
```

### 1. Data Exploration


```{r}

summary(df)
str(df)

```

#### A. Summary Statistics

The data consists of 466 observations and 13 variables, all numeric.  Two are binary, including the target. There are no missing values.  The target appears to be relatively balanced (which makes sense, as it is an indicator of being above or below the median.)


```{r}
library(psych)

a <- EHSummarize_StandardPlots(df, "target", type="box")
```

Looking at boxplots, histograms, and boxplots against the target variable, we see some areas of interest.  A number of distributions are broken (e.g. zn, indus, nox and rad ), suggesting there may be hidden grouping within the variables.  For example, zn = 0 may include areas that are different in their makeup from zn>0.  In fact, there may be a common phenomenon among all opf them which identifies certain areas as highly industrial, as opposed to the mixed industrial and residential areas for the rest of the observations.  

Most of the correlations are unsurprising, with the exception of tax rate, which increases with increase in crime.

#### B. Multicollinearity

```{r}
EHExplore_Multicollinearity(df, run_all=FALSE)


```
Mutlicollinearity is highly evident in the database - not surprisingly.  The correlation between rad and tax is over 90%. 

### 2. Data Preparation

#### A. Interaction terms

The dataset appears to hold the potential for many interaction terms, as many distributions suggest areas of very low industrialization and very high industrialization, which may affect the slope of other variables.  The following are just some of the possible interactions affecting the dataset:

```{r}

dfInt <- df %>%
    mutate(TaxOver600 = ifelse(tax>=600,1,0)) %>%
    mutate(radOver10 = ifelse(rad>=10,1,0)) %>%
    mutate(ptOver14 = as.numeric(ifelse(ptratio>=14,1,0))) %>%
    mutate(lstatOver12 = ifelse(lstat>=12,1,0)) %>%
    mutate(IndusOver16 = ifelse(indus>=16,1,0)) %>%
    mutate(ZnOver0 = ifelse(zn>0,1,0)) %>%
    mutate(NoxOverPoint8 = ifelse(nox>=.8,1,0)) %>%
    mutate(MedvBelow50 = ifelse(medv<50,1,0))

a <- EHExplore_Interactions_Scatterplots(dfInt, "target", "ZnOver0")
b <- EHExplore_Interactions_Scatterplots(dfInt, "target", "IndusOver16")
c <- EHExplore_Interactions_Scatterplots(dfInt, "target", "radOver10")
d <- EHExplore_Interactions_Scatterplots(dfInt, "target", "TaxOver600")
e <- EHExplore_Interactions_Scatterplots(dfInt, "target", "ptOver14")

x <- c(a[2], a[5], a[9], b[4], b[6], c[11], d[10], e[8], e[2], e[9])

grid.arrange(grobs=x, ncol=3, nrow=4)

```

From these plots, we might draw a number of conclusions.  First, in the most highly industrialized areas the crime rate appears to be high no matter the other factors. Zone 0 areas behave differently from zone 1 areas. In the few schools the pt ratio is very small, crime rates fall when they rise in schools with higher pt ratios.  There may be other conclusions we can draw as well.

#### B. Transformations

When the predictor variable is normally distributed but with different variance for the two values of y, we may try a quadratic function of x.  rm may be considered a reasonable candidate for this.  For skewed distributions, we may include both x and log(x).  nox, age, dis and lstat may be candidates for this. 


### 3. Build Models

We begin with the base model (include all original variables form the dataset).  We split the data 80/20 to compare a training model to a test set:

```{r}
EHModel_Regression_Logistic(df, "target")

```

The base model alone is an excellent predictor of crime rate. Only 4 of the 12 predictors are not significant.


Now we try a modle with all of our transformations and interaction terms:

```{r}

dfInt2 <- dfInt %>%
  mutate(rmSquared = rm^2,nox_log = log(nox), age_log = log(age),dis_log = log(dis),lstat_log = log(lstat))
```

```{r include=FALSE}

acc = list()

for (i in 1:100)
{
  q <- EHModel_Regression_Logistic(dfInt2, "target")
  acc[i]=q[2]
}

```
```{r}
accv <- unlist(acc)
aveq <- mean(accv)
print(aveq)

```


Our AIC is actually lower, but the model does not do a better job predicting outcomes.
 
```{r}

#a <- EHModel_Regression_Logistic(df, "target")

  logistic_model <- glm(target ~ .,
                        data = df,
                        family = "binomial")

str(df)

  print(logistic_model)
 #mmps(logistic_model)

  #df22$ptratio = scale(df22$ptratio)
 
 df23 <- df22 %>%
   dplyr::filter(ptratio>13)
 

 
   m2 <- glm(target ~ .,
                data = df23,
                family = "binomial")
     print(m2)
 mmps(m2)

```
```{r}

df2 <- df %>%
  mutate_at(c(1:12), scale)

EHModel_Regression_Logistic(df2, "target")

```

```{r}

df1 <- df %>%
  dplyr::select(nox, dis, rad, ptratio, medv, target)

EHModel_Regression_Logistic(df1, "target")


```
```{r}

dfT <- df %>%
  mutate(TaxOver600 = ifelse(tax>=600,1,0))

EHExplore_Interactions_Scatterplots(dfT, "target", "TaxOver600")

```

```{r}

dfT2 <- df %>%
  mutate(IndusOver16 = ifelse(indus>=16,1,0))

wrap_plots(EHExplore_Interactions_Scatterplots(dfT2, "target", "IndusOver16"))

```

```{r}

df4 <- dfT %>%
  mutate(lstatOver12 = ifelse(lstat>12,1,0), Inter_taxOver600_lstat = TaxOver600*lstat, Inter_lstatOver12_medv = lstatOver12*medv, IndusOver16 = ifelse(indus>=16,1,0)) 

#EHExplore_TwoCategoricalColumns_Barcharts(dfT, "TaxOver600")
wrap_plots(EHExplore_Interactions_Scatterplots(df4, "target", "lstatOver12"))
```

```{r}


plot(EHModel_Regression_Logistic(df4, "target")) 

```

```{r}


df5 <- df4 %>%
  dplyr::filter(rownames(df4) != 338)

df6 <- df5 %>%
  dplyr::select(-IndusOver16) %>%
  mutate(zn=log(zn+1))


plot(EHModel_Regression_Logistic(df6, "target"))


```

```{r}

df11 <- df5 %>%
  dplyr::select(target, zn, nox, age, dis, rad, ptratio, medv, indus, IndusOver16) %>%
  mutate(inter = indus*IndusOver16)

EHModel_Regression_Logistic(df11, "target")

```


```{r}

```

Building Interactions
```{r}

dfInt <- df %>%
  mutate(TaxOver600 = ifelse(tax>=600,1,0)) %>%
    mutate(ptOver13 = as.numeric(ifelse(ptratio>13,1,0))) %>%
    mutate(lstatOver12 = ifelse(lstat>12,1,0)) %>%
    mutate(IndusOver16 = ifelse(indus>=16,1,0)) %>%
    mutate(ZnOver0 = ifelse(zn>0,1,0)) %>%
    mutate(NoxOverPoint8 = ifelse(nox>=.8,1,0)) %>%
    mutate(MedvBelow50 = ifelse(medv<50,1,0))

EHModel_Regression_Logistic(dfInt, "target")

a <- EHExplore_Interactions_Scatterplots(dfInt, "target", "MedvBelow50")
grid.arrange(grobs=a[1:9], ncol=3, nrow=3)
grid.arrange(grobs=a[10:18], ncol=3, nrow=3)
grid.arrange(grobs=a[19:20], ncol=2, nrow=1)

```

```{r}

a <- EHExplore_Interactions_Scatterplots(dfInt, "target", "NoxOverPoint8")
grid.arrange(grobs=a[1:9], ncol=3, nrow=3)
grid.arrange(grobs=a[10:18], ncol=3, nrow=3)
grid.arrange(grobs=a[19:20], ncol=2, nrow=1)
```

```{r}


a <- EHExplore_Interactions_Scatterplots(dfInt, "target", "ZnOver0")
grid.arrange(grobs=a[1:9], ncol=3, nrow=3)
grid.arrange(grobs=a[10:18], ncol=3, nrow=3)
grid.arrange(grobs=a[19:20], ncol=2, nrow=1)
```

```{r}



a <- EHExplore_Interactions_Scatterplots(dfInt, "target", "IndusOver16")
grid.arrange(grobs=a[1:9], ncol=3, nrow=3)
grid.arrange(grobs=a[10:18], ncol=3, nrow=3)
grid.arrange(grobs=a[19:20], ncol=2, nrow=1)


a <- EHExplore_Interactions_Scatterplots(dfInt, "target", "lstatOver12")
grid.arrange(grobs=a[1:9], ncol=3, nrow=3)
grid.arrange(grobs=a[10:18], ncol=3, nrow=3)
grid.arrange(grobs=a[19:20], ncol=2, nrow=1)


a <- EHExplore_Interactions_Scatterplots(dfInt, "target", "ptOver13")
grid.arrange(grobs=a[1:9], ncol=3, nrow=3)
grid.arrange(grobs=a[10:18], ncol=3, nrow=3)
grid.arrange(grobs=a[19:20], ncol=2, nrow=1)


a <- EHExplore_Interactions_Scatterplots(dfInt, "target", "TaxOver600")
grid.arrange(grobs=a[1:9], ncol=3, nrow=3)
grid.arrange(grobs=a[10:18], ncol=3, nrow=3)
grid.arrange(grobs=a[19:20], ncol=2, nrow=1)

  
#LstatOver12
#IndusOver16
#ptOver13
#ZnOver0
#NoxOverPoint8
#radOver15
#TaxOver600
#ptratioBelow20
#medvBelow50








```

```{r}

table(dfInt$ZnOver0, dfInt$NoxOverPoint)

```

```{r}

dfInt2 <- dfInt %>%
  mutate(inter_z_rm = ZnOver0*rm) %>%
  mutate(inter_z_medv = ZnOver0*medv) %>%
  mutate(inter_z_indus = ZnOver0*indus) %>% 
  mutate(inter_lstatOver12_pt = lstatOver12*ptratio) %>%
  mutate(inter_tax_rm = TaxOver600*indus) 

dfInt3 <- dfInt2 %>%
  dplyr::select(inter_z_rm, inter_z_medv,inter_z_indus, inter_lstatOver12_pt, inter_tax_rm, zn, rm, medv, indus, ZnOver0, lstatOver12, TaxOver600, target)

EHModel_Regression_Logistic(dfInt2, "target")
  
```


